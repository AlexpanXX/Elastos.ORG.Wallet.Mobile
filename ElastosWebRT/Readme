# elastos_web_rt 说明
## 下载代码

```
$git clone https://github.com/elastos/Elastos.Trinity.android trinty
```

## 配置参数

```
$gn args out/arm
```

按照下面参数配置

```
target_os="android"
target_cpu = "arm"
is_debug=false
symbol_level=1
is_official_build=true
is_chrome_branded=false
use_official_google_api_keys=false
enable_resource_whitelist_generation=false
ffmpeg_branding="Chrome"
proprietary_codecs=true
enable_remoting=true
```

## 编译

```
$ninja -C out/arm elastos_webrt_apk
```

生成的文件，我们需要两个：
Elastos.Trinity.android/src/out/arm/apks/ElastosWebRT.apk和Elastos.Trinity.android/src/out/arm/lib.java/elastos_webrt_java.jar

## 处理目标文件
由于我们需要把jar包和so提供给studio环境使用，而chromium构建中有部分代码是在生成apk时才自动填充，所以我们分离出的jar包目前需要手动替换，请按下面的步骤进行操作：

    a. 手动替换elastos_webrt_java.jar中nativelibrary，buildconfig目录下的class文件。
    用Elastos.Trinity.android/src/out/arm/gen/content/cordova/android/elastos_webrt_apk/elastos_webrt_apk.jar里的/org/chromium/base/
    替换Elastos.Trinity.android/src/out/arm/lib.java/elastos_webrt_java.jar里的/org/chromium/base/
    b. 删除elastos_webrt_java.jar中与AndroidStudio冲突的package(com.android.support)，目录如下：
    elastos_webrt_java.jar/android/support/v4

## ElastosWebRT 输出主要包含如下文件：
    elastos_webrt_java.jar(chromium java 层代码生成的jar包)
    cordovaLib (cordava 库代码)
    asset(dat，bin，pak即chromium相关资源文件)
    Build.gradle(diff)
    manifest.xml(diff)
    android.jar
使用方式有点复杂，但如果是基于Elastos.ORG.Wallet开发并不需要做这些复杂的操作，只需要clone 下来，替换一下sdk里的android.jar包就可以了。只有开发web engine的人员才需要处理。

# Studio 工程搭建(Elastos.ORG.Wallet.Mobile.git仓库)

## sdk 中的android.jar包替换
由于chromium会使用到部分android sdk未开放的api，所以需要替换公共发布的sdk里的android.jar文件，这个文件已经拷贝到Elastos.ORG.Wallet.Mobile.git仓库的ds分支ElastosWebRT目录下（该文件实际使用chromium_src/.cipd/pkgs/35/_current/android_system.jar替换
android-sdk/platforms/android-26/android.jar）


## 下载代码
git clone git@github.com:elastos/Elastos.ORG.Wallet.Mobile.git wallet

拉下来的代码使用chromium的so和jar包都是已经处理好的，直接编译即可，只有chromium发生变化才需要执行下面的步骤：

## 如果修改c++文件，需要替换相应so
    a. 将ElastosWebRT.apk中的lib/armeabi-v7a中的so文件拷贝到platforms/android/app/src/main/jniLibs/armeabi-v7a目录；

## 如果修改了Java文件，需要替换jar包和assets下的资源文件，并且需要按照前面chromium编译的方式处理
    b. 将elastos_webrt_java.jar拷贝到platforms/android/CordovaLib/libs目录；

    c. 将ElastosWebRT.apk中assets目录下的icudtl.dat,natives_blob.bin,snapshot_blob_32.bin,content_shell.pak文件拷贝到
       platforms/android/app/src/main/assets目录。
       在platforms/android/app/build.gradle 中添加如下几行
         aaptOptions {
             noCompress 'dat', 'bin', 'pak'
         }

下面d和e一般不需要再次修改：

    d. 在platforms/android/app/src/main/AndroidManifest.xml中添加SandboxedProcess相关的几项：
    --- a/platforms/android/app/src/main/AndroidManifest.xml
    +++ b/platforms/android/app/src/main/AndroidManifest.xml
    @@ -99,6 +99,138 @@
             </receiver>
             <meta-data android:name="JPUSH_CHANNEL" android:value="developer-default" />
             <meta-data android:name="JPUSH_APPKEY" android:value="ce32fee188af2d3284b0c24e" />
    +
    +        <meta-data
    +            android:name="org.chromium.content.browser.NUM_SANDBOXED_SERVICES"
    +            android:value="20" />
    +
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService0"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process0" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService1"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process1" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService2"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process2" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService3"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process3" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService4"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process4" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService5"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process5" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService6"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process6" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService7"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process7" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService8"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process8" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService9"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process9" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService10"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process10" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService11"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process11" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService12"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process12" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService13"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process13" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService14"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process14" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService15"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process15" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService16"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process16" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService17"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process17" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService18"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process18" />
    +        <service
    +            android:name="org.chromium.content.app.SandboxedProcessService19"
    +            android:exported="false"
    +            android:isolatedProcess="true"
    +            android:process=":sandboxed_process19" />
    +
    +        <meta-data
    +            android:name="org.chromium.content.browser.NUM_PRIVILEGED_SERVICES"
    +            android:value="3" />
    +
    +        <service
    +            android:name="org.chromium.content.app.PrivilegedProcessService0"
    +            android:exported="false"
    +            android:isolatedProcess="false"
    +            android:process=":privileged_process0" />
    +        <service
    +            android:name="org.chromium.content.app.PrivilegedProcessService1"
    +            android:exported="false"
    +            android:isolatedProcess="false"
    +            android:process=":privileged_process1" />
    +        <service
    +            android:name="org.chromium.content.app.PrivilegedProcessService2"
    +            android:exported="false"
    +            android:isolatedProcess="false"
    +            android:process=":privileged_process2" />
    +
    +        <meta-data
    +            android:name="org.chromium.content.browser.SMART_CLIP_PROVIDER"
    +            android:value="org.chromium.content.browser.SmartClipProvider" />
    +        <meta-data
    +            android:name="android.arch.lifecycle.VERSION"
    +            android:value="27.0.0-SNAPSHOT" />
         </application>
         <uses-sdk android:minSdkVersion="19" android:targetSdkVersion="21" />
         <uses-permission android:name="android.permission.CAMERA" />
    e. 将CordovaLib目录下的java文件替换为附件CordovaLib(从chromium/content/cordova/android/CordovaLib拷贝过来)文件夹。
    ElastosWebRT/CordovaLib ==> platforms/android/CordovaLib

## 编译studio工程，生成对应apk
    f. sync studio工程，编译生成apk
